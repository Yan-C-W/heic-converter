import os
from io import BytesIO
from flask import Flask, request, send_file, jsonify
from PIL import Image
from pillow_heif import register_heif_opener

# 1. Register the HEIF opener plugin
# This tells the system how to read the special HEIC format
register_heif_opener()

app = Flask(__name__)

# Allowed output formats
ALLOWED_FORMATS = {'jpg', 'png'}

@app.route('/convert', methods=['POST'])
def convert_heic():
    # Check if a file was actually sent
    if 'file' not in request.files:
        return jsonify({"error": "No file part in the request"}), 400
    
    file = request.files['file']
    
    if file.filename == '':
        return jsonify({"error": "No selected file"}), 400

    # Get the desired format (default to jpg if not specified)
    output_format = request.form.get('format', 'jpg').lower()
    
    if output_format not in ALLOWED_FORMATS:
        return jsonify({"error": "Invalid format. Use 'jpg' or 'png'"}), 400

    try:
        # 2. Open the image directly from memory
        image = Image.open(file.stream)
        
        # 3. Create a memory buffer to hold the converted image
        output_buffer = BytesIO()
        
        # Save the image into the buffer based on format
        if output_format == 'jpg':
            # Convert to RGB mode (needed for JPG) in case it's transparent
            image = image.convert("RGB") 
            image.save(output_buffer, format='jpeg', quality=85)
            mime_type = 'image/jpeg'
        else:
            image.save(output_buffer, format='png')
            mime_type = 'image/png'
        
        # Reset buffer position to the start so it can be read
        output_buffer.seek(0)
        
        # 4. Send the new file back to the requester
        new_filename = f"converted.{output_format}"
        return send_file(
            output_buffer,
            mimetype=mime_type,
            as_attachment=True,
            download_name=new_filename
        )
        
    except Exception as e:
        print(f"Error: {e}")
        return jsonify({"error": "Conversion failed. File may be corrupt."}), 500

if __name__ == '__main__':
    # This runs the server on port 5000
    app.run(debug=True, host='0.0.0.0', port=5000)